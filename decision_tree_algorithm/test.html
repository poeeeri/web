<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Дерево решений</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Алгоритм дерева решений</h1>

    <h2>1. Обучающая выборка (CSV)</h2>
    <input type="file" accept=".csv" onchange="loadTrainFile(event)">
    <textarea id="trainInput" rows="8" cols="60" placeholder="Цвет,Размер,Форма,Класс\nКрасный,Большой,Круг,Да\n..."></textarea>
    <br>
    <button onclick="trainTree()">Построить дерево</button>
    <pre id="treeOutput"></pre>

    <h2>2. Данные для классификации (CSV)</h2>
    <input type="file" accept=".csv" onchange="loadTestFile(event)">
    <textarea id="testInput" rows="4" cols="60" placeholder="Синий,Большой,Круг"></textarea>
    <br>
    <button onclick="classifyInput()">Классифицировать</button>
    <pre id="classOutput"></pre>

    <script>
//******
        function parseCSV(text) {
            return text.trim().split('\n').map(line => line.split(','));
        }
//******
        function loadTrainFile(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('trainInput').value = e.target.result;
            };
            reader.readAsText(file);
        }
//******
        function loadTestFile(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('testInput').value = e.target.result;
            };
            reader.readAsText(file);
        }

        function buildTree(data, attributes) {
            const labels = [...new Set(data.map(row => row[row.length - 1]))];
            if (labels.length === 1) {
                return { isLeaf: true, prediction: labels[0] };
            }

            if (attributes.length === 0) {
                const counts = {};
                for (let row of data) {
                    const label = row[row.length - 1];
                    counts[label] = (counts[label] || 0) + 1;
                }
                const prediction = Object.entries(counts).sort((a, b) => b[1] - a[1])[0][0];
                return { isLeaf: true, prediction };
            }

            let bestAttrIndex = 0;
            let maxUnique = 0;
            for (let i = 0; i < attributes.length; i++) {
                const uniqueVals = new Set(data.map(row => row[i])).size;
                if (uniqueVals > maxUnique) {
                    maxUnique = uniqueVals;
                    bestAttrIndex = i;
                }
            }

            const attribute = attributes[bestAttrIndex];
            const node = {
                isLeaf: false,
                attribute: attribute,
                children: {}
            };

            const values = [...new Set(data.map(row => row[bestAttrIndex]))];
            for (let val of values) {
                const filtered = data.filter(row => row[bestAttrIndex] === val);
                const newAttrs = attributes.slice();
                newAttrs.splice(bestAttrIndex, 1);
                const newData = filtered.map(row => row.filter((_, idx) => idx !== bestAttrIndex));
                node.children[val] = buildTree(newData, newAttrs);
            }

            return node;
        }

        function classify(tree, input, path = []) {
            if (tree.isLeaf) {
                path.push({ type: 'leaf', prediction: tree.prediction });
                return { prediction: tree.prediction, path };
            }

            const value = input[tree.attribute];
            path.push({ type: 'node', attribute: tree.attribute, value });

            const child = tree.children[value];
            if (!child) return { prediction: 'unknown', path };

            return classify(child, input, path);
        }

        let tree;
        let headers = [];
//??????
        function trainTree() {
            const csv = document.getElementById('trainInput').value;
            const data = parseCSV(csv);
            headers = data[0];
            const rows = data.slice(1);

            tree = buildTree(rows, headers.slice(0, -1));
            document.getElementById('treeOutput').textContent = JSON.stringify(tree, null, 2);
        }

        function classifyInput() {
            const inputCsv = document.getElementById('testInput').value;
            const input = parseCSV(inputCsv)[0];

            const inputObj = {};
            for (let i = 0; i < headers.length - 1; i++) {
                inputObj[headers[i]] = input[i];
            }

            const result = classify(tree, inputObj);
            let output = `Результат: ${result.prediction}\nПуть:\n`;
            for (let step of result.path) {
                if (step.type === 'leaf') {
                    output += `\u2192 [Лист] Класс: ${step.prediction}\n`;
                } else {
                    output += `\u2192 ${step.attribute} = ${step.value}\n`;
                }
            }
            document.getElementById('classOutput').textContent = output;
        }
    </script>
</body>
</html>
